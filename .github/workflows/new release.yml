name: Shorebird Release (main)

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  shorebird-release:
    runs-on: ubuntu-latest

    steps:
      - name: 📚 Checkout
        uses: actions/checkout@v4

      - name: 🐦 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.35.6
          cache: true

      - name: 🏗️ Setup Shorebird
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true

      - name: 📦 Get Dependencies
        run: flutter pub get

      - name: 🚀 Shorebird Release (Android)
        run: shorebird release android --artifact apk
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      - name: 📝 Get Version Info
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d '\r')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: 🔄 Rename APK and AAB
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk \
            build/app/outputs/flutter-apk/my_ufape-v${{ steps.version.outputs.version }}.apk
          
          mv build/app/outputs/bundle/release/app-release.aab \
            build/app/outputs/bundle/release/my_ufape-v${{ steps.version.outputs.version }}.aab

      - name: 📤 Create GitHub Release and Attach APK & AAB
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}-build-${{ github.run_number }}
          name: v${{ steps.version.outputs.version }} (Build ${{ github.run_number }})
          generate_release_notes: true
          files: |
            build/app/outputs/flutter-apk/my_ufape-v${{ steps.version.outputs.version }}.apk
            build/app/outputs/bundle/release/my_ufape-v${{ steps.version.outputs.version }}.aab
